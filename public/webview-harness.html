<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebView Test Harness</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 12px;
      }
      header {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 8px 12px;
        cursor: pointer;
      }
      iframe {
        width: 100%;
        height: 75vh;
        border: 1px solid #ccc;
        margin-top: 12px;
      }
      pre {
        background: #f6f8fa;
        padding: 8px;
        max-height: 200px;
        overflow: auto;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .spacer {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <header>
      <strong>Parent Host (WebView/iframe)</strong>
      <div class="spacer"></div>
      <div class="row">
        <button id="btnStart">START (LOAD_MAP_AND_CHALLENGE)</button>
        <button id="btnRun">RUN_PROGRAM</button>
        <button id="btnStatus">GET_STATUS</button>
        <button id="btnPhysRun">RUN PHYSICAL ACTIONS</button>
        <button id="btnPhysStatus">GET PHYSICAL STATUS</button>
        <button id="btnReplay">REPLAY</button>
        <button id="btnClear">Clear Log</button>
      </div>
    </header>

    <pre id="log"></pre>

    <!-- Game loads here; ensure src points to your app entry (Vite index.html) -->
    <iframe id="game" src="/index.html"></iframe>

    <script>
      const logEl = document.getElementById("log");
      const gameFrame = document.getElementById("game");

      function log(...args) {
        const line = args
          .map((a) => (typeof a === "string" ? a : JSON.stringify(a)))
          .join(" ");
        logEl.textContent += line + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }

      document.getElementById("btnClear").onclick = () =>
        (logEl.textContent = "");

      // Receive messages from the game
      window.addEventListener("message", (event) => {
        const msg = event.data;
        if (!msg || msg.source !== "phaser-robot-game") return;
        log("← from game:", msg.type, msg.data || {});
      });

      function sendToGame(type, data = {}) {
        const message = {
          source: "parent-website",
          type,
          data,
          timestamp: Date.now(),
        };
        gameFrame.contentWindow?.postMessage(message, "*");
        log("→ to game:", type);
      }

      // Buttons
      document.getElementById("btnStart").onclick = async () => {
        console.log("🔄 START button clicked!");
        try {
          // Load từ mapString - CẬP NHẬT ĐỂ KHỚP VỚI test.json
          const mapString =
            '{"compressionlevel":-1,"height":10,"infinite":false,"layers":[{"data":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,1,6,1,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"height":10,"id":1,"name":"Tile Layer 1","opacity":1,"type":"tilelayer","visible":true,"width":10,"x":0,"y":0}],"nextlayerid":2,"nextobjectid":1,"orientation":"isometric","renderorder":"right-down","tiledversion":"1.11.2","tileheight":80,"tilesets":[{"columns":1,"firstgid":1,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"road_v","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128},{"columns":1,"firstgid":2,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"road_h","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128},{"columns":1,"firstgid":3,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"wood","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128},{"columns":1,"firstgid":4,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"water","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128},{"columns":1,"firstgid":5,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"grass","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128},{"columns":1,"firstgid":6,"image":".","imageheight":128,"imagewidth":128,"margin":0,"name":"crossroad","spacing":0,"tilecount":1,"tileheight":128,"tilewidth":128}],"tilewidth":128,"type":"map","version":"1.10","width":10}';
          const mapJson = JSON.parse(mapString);

          // Load từ challengeString thay vì fetch từ file
          const challengeString =
            '{"robot":{"tile":{"x":3,"y":4},"direction":"east"},"batteries":[{"tiles":[{"x":5,"y":4,"count":2,"type":"yellow","spread":1.2,"allowedCollect":true},{"x":7,"y":4,"count":2,"type":"yellow","spread":1.2,"allowedCollect":true}]}],"victory":{"byType":[{"red":0,"yellow":4,"green":0}],"description":"Help me collect the yellow 🟨 battery!💡With the repeat block, you can loop code over and over."},"statement":["forward","collect"],"minCards":3,"maxCards":5}';
          const challengeJson = JSON.parse(challengeString);

          // Log để kiểm tra dữ liệu trước khi gửi
          console.log("📤 Sending data from strings:");
          console.log("  📁 MapJson:", {
            type: typeof mapJson,
            orientation: mapJson.orientation,
            layers: mapJson.layers?.length,
            tilesets: mapJson.tilesets?.length,
            firstLayerName: mapJson.layers?.[0]?.name,
            tileheight: mapJson.tileheight,
            tilewidth: mapJson.tilewidth,
          });
          console.log("  🎯 ChallengeJson:", {
            type: typeof challengeJson,
            robot: !!challengeJson.robot,
            robotPosition: challengeJson.robot?.tile,
            robotDirection: challengeJson.robot?.direction,
            batteries: challengeJson.batteries?.length || 0,
            victory: !!challengeJson.victory,
            minCards: challengeJson.minCards,
            maxCards: challengeJson.maxCards,
          });

          console.log("📤 Full objects:", { mapJson, challengeJson });

          sendToGame("LOAD_MAP_AND_CHALLENGE", { mapJson, challengeJson });
        } catch (e) {
          console.error("❌ Error details:", e);
          log("⚠️ Failed to load map/challenge:", e.message || e);
        }
      };

      document.getElementById("btnRun").onclick = () => {
        // Gửi chương trình Blockly JSON chuẩn (headless compile)
        const program = {
          version: "1.0.0",
          programName: "demo_headless",
          actions: [
            { type: "forward", count: 2 },
            { type: "collect", color: "yellow", count: 2 },
            { type: "forward", count: 2 },
            { type: "collect", color: "yellow", count: 2 },
          ],
        };
        sendToGame("RUN_PROGRAM_HEADLESS", { program });
      };

      document.getElementById("btnStatus").onclick = () => {
        sendToGame("GET_STATUS");
      };

      // Run a demo list of physical robot actions
      document.getElementById("btnPhysRun").onclick = () => {
        const actions = [
          { type: "forward", count: 2 },
          { type: "collect", color: "yellow", count: 2 },
          { type: "forward", count: 2 },
          { type: "collect", color: "yellow", count: 2 },
        ];
        sendToGame("EXECUTE_PHYSICAL_ROBOT_ACTIONS", { actions });
      };

      // Query physical robot execution status
      document.getElementById("btnPhysStatus").onclick = () => {
        sendToGame("GET_PHYSICAL_ROBOT_STATUS");
      };

      // Replay: ask the game to restart/reload the scene
      document.getElementById("btnReplay").onclick = () => {
        sendToGame("RESTART_SCENE");
      };

      // Optional: Mock a Flutter-like channel for quick testing (shown in console)
      window.PhaserChannel = window.PhaserChannel || {
        postMessage: (s) => console.log("PhaserChannel.postMessage →", s),
        emit: (type, data) => console.log("PhaserChannel.emit →", type, data),
        on: () => () => {},
      };
    </script>
  </body>
</html>
